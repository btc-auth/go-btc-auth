# 比特币私钥认证协议

## 目录

1. 引言
2. 协议概述
3. 技术架构
   3.1. 服务器端组件
   3.2. 客户端要求
4. 认证流程
   4.1. 令牌生成
   4.2. 二维码创建
   4.3. 客户端签名
   4.4. 服务器验证
5. 安全性考虑
6. 实现细节
7. 未来增强
8. 结论

## 1. 引言

本白皮书介绍了一种新颖的认证协议，该协议利用比特币私钥进行安全的用户认证。通过利用比特币的加密原理，该协议提供了一种强大的、去中心化的认证机制，适用于各种应用场景。

## 2. 协议概述

比特币私钥认证协议使用户能够使用其比特币私钥进行身份认证，而无需泄露私钥本身。这是通过涉及数字签名的挑战-响应机制实现的。

主要特点：
- 利用现有的比特币基础设施
- 服务器上不存储密码
- 抵御钓鱼和中间人攻击
- 通过扫描二维码提供无缝的用户体验

## 3. 技术架构

### 3.1. 服务器端组件

服务器架构包括以下关键组件：

1. **令牌管理器**：生成和管理认证令牌。
2. **二维码生成器**：创建包含认证挑战的二维码。
3. **签名验证器**：使用公钥验证客户端签名的消息。
4. **会话管理器**：维护已认证用户的会话。

### 3.2. 客户端要求

客户端需要一个能够：
- 扫描二维码
- 使用私钥签名任意消息
- 导出相应公钥
的比特币钱包。

## 4. 认证流程

### 4.1. 令牌生成

1. 服务器使用加密安全的随机数生成器为每次认证尝试生成一个唯一的令牌。
2. 令牌与创建时间戳关联，并具有可配置的过期时间，通常设置为短暂的持续时间（例如60秒），以最小化重放攻击的风险。

### 4.2. 二维码创建

1. 服务器构造一个具有以下格式的认证URL：
   ```
   http://<server_host>:<port>/auth?token=<generated_token>&sign={sign}&public_key_hex={public_key_hex}
   ```
   其中：
   - `<server_host>` 是认证服务器的域名或IP地址
   - `<port>` 是服务器监听的端口号
   - `<generated_token>` 是在步骤4.1中生成的唯一令牌
   - `{sign}` 是客户端签名的占位符
   - `{public_key_hex}` 是客户端公钥的十六进制格式占位符

2. 使用诸如go-qrcode之类的库将此URL编码成二维码。

### 4.3. 客户端签名

1. 客户端使用其比特币钱包应用程序扫描二维码。
2. 钱包从二维码中提取认证URL。
3. 钱包使用用户的私钥创建整个认证URL的ECDSA（椭圆曲线数字签名算法）签名。过程如下：
   a. 钱包使用SHA-256对URL进行哈希处理。
   b. 使用用户的私钥和secp256k1椭圆曲线（与比特币使用的相同曲线）对结果哈希进行签名。
   c. 签名通常以DER（区分编码规则）格式生成。
4. 钱包将DER签名转换为十六进制字符串。
5. 钱包还导出用户的公钥并将其转换为十六进制字符串。
6. 钱包用实际的签名和公钥十六进制字符串替换URL中的`{sign}`和`{public_key_hex}`占位符。
7. 将完成的URL作为HTTP GET请求发送回服务器。

### 4.4. 服务器验证

1. 服务器接收包含完成的认证URL的GET请求。
2. 从URL参数中提取令牌、签名和公钥。
3. 服务器通过检查令牌的创建时间戳与当前时间来验证令牌是否过期。
4. 如果令牌有效，服务器继续验证签名：
   a. 使用接收到的令牌和`{sign}`和`{public_key_hex}`占位符重构原始认证URL。
   b. 服务器使用SHA-256对这个重构的URL进行哈希处理。
   c. 然后使用提供的公钥验证签名是否与重构URL的哈希匹配。
5. 签名验证过程使用以下步骤：
   a. 从十六进制表示中解析公钥。
   b. 从十六进制表示中解析签名并从DER格式转换。
   c. 使用ECDSA验证算法检查签名是否对重构URL的哈希有效，使用提供的公钥。
6. 如果签名有效，服务器将公钥与用户会话关联，有效地对用户进行认证。

这个过程确保只有拥有与提供的公钥对应的私钥的用户才能为给定的认证URL生成有效签名。对每次认证尝试使用唯一的令牌可以防止重放攻击，因为先前使用的URL将包含过期的令牌，从而被服务器拒绝。

## 5. 安全性考虑

- **令牌过期**：令牌具有短暂的生命周期，以最小化重放攻击的风险。
- **签名验证**：强大的签名验证防止伪造尝试。
- **私钥不传输**：私钥永远不会离开客户端设备。
- **唯一挑战**：每次认证尝试使用唯一的令牌，防止重放攻击。

## 6. 实现细节

该协议使用以下技术实现：

- **服务器**：Go（Golang）与Gin Web框架
- **密码学**：btcd/btcec库用于比特币兼容的椭圆曲线操作
- **二维码生成**：go-qrcode库
- **前端**：带有嵌入式二维码的HTML模板

关键代码片段：

```go
func VerifySignature(message, signatureHex, publicKeyHex string) (bool, error) {
    // 实现细节...
}

func GenerateSignature(message string, privateKey *btcec.PrivateKey) (string, error) {
    // 实现细节...
}
```

## 7. 未来增强

- 多因素认证选项
- 与硬件钱包集成
- 支持其他加密货币密钥对
- 分布式服务器架构以提高可扩展性

## 8. 结论

比特币私钥认证协议提供了一种安全、用户友好的认证机制，利用了比特币的强大加密基础。通过消除密码存储的需求并利用现有的钱包基础设施，该协议为传统认证方法提供了一种有前景的替代方案。